#!/bin/bash

# AI CLI AutoSave Clean - Produces clean, readable logs without escape codes
# https://github.com/sburakc/ai-cli-autosave
# Version: 1.0.0

# Default configuration
DEFAULT_LOG_DIR="${AI_LOG_DIR:-.ai-cli-autosave}"
DEFAULT_AI_TOOL="${1:-claude}"

# Color codes for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse arguments
COMMAND="${1:-$DEFAULT_AI_TOOL}"
shift 2>/dev/null || true

# Create log directory
LOG_DIR="$DEFAULT_LOG_DIR"
mkdir -p "$LOG_DIR"

# Generate timestamp and filenames
timestamp=$(date +"%Y%m%d-%H%M%S")
LOG_FILE="$LOG_DIR/${COMMAND}-${timestamp}-clean.txt"
TEMP_FILE="$LOG_DIR/.temp-${timestamp}.txt"

# Print startup message
echo -e "${GREEN}=== AI CLI AutoSave Clean ===${NC}"
echo -e "${BLUE}Command:${NC} $COMMAND"
echo -e "${BLUE}Log file:${NC} $LOG_FILE"
echo -e "${GREEN}==============================${NC}"
echo

# Function to clean ANSI escape codes
cleanup_and_save() {
    if [ -f "$TEMP_FILE" ]; then
        # Add header
        {
            echo "=== $COMMAND Session Log ==="
            echo "Started: $(date)"
            echo "Working Directory: $(pwd)"
            echo "============================="
            echo
        } > "$LOG_FILE"
        
        # Clean and append content
        sed 's/\x1b\[[0-9;]*[a-zA-Z]//g' "$TEMP_FILE" | \
        sed 's/\x1b\]0;//g' | \
        sed 's/\x07//g' | \
        sed 's/\r//g' | \
        sed '/^\[?1004h$/d' | \
        sed '/^\[?2004[hl]$/d' | \
        sed '/^\[2J\[3J\[H$/d' | \
        sed '/^$/N;/^\n$/d' >> "$LOG_FILE"
        
        # Add footer
        {
            echo
            echo "============================="
            echo "Ended: $(date)"
        } >> "$LOG_FILE"
        
        # Remove temp file
        rm -f "$TEMP_FILE"
        
        echo -e "\n${GREEN}Clean session saved to: $LOG_FILE${NC}"
    fi
}

# Set up cleanup on exit
trap cleanup_and_save EXIT INT TERM

# Use script to capture everything
script -q "$TEMP_FILE" -c "$COMMAND $*"